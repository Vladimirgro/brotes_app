{% extends "layout.html" %}

{% block head %}

<!-- DataTables + Botones -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<style>
    /* Estilos para el tamaño de los controles */
    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {        
        width: 50px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem; /* Tamaño reducido */
        border-radius: 25px;
    }

    /* Controles alineados horizontalmente */
    .dataTables_wrapper .dataTables_filter {
        width: 100px !important;
        float: left !important;
        text-align: left !important;
    }
    .dataTables_wrapper .dataTables_length {        
        width: 80px !important;
        float: right !important;
        text-align: right !important;
    }

    /* Estilos para botones del paginado */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.3rem 0.6rem;
        font-size: 0.875rem;
        border-radius: 5px;
        background-color: #0d6efd;
        color: white !important;
        margin: 0 2px;
        border: none;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background-color: #0b5ed7;
        color: white !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background-color: #198754 !important;
        color: white !important;
    }

    .table tbody tr td {
        font-size: 6px;
    }    


    /* Estilos adicionales para mejorar la visualización */
    #tablaBrotes {
        font-size: 12px;
        width: 100%;
    }


    /* Responsive adjustments */
    @media (max-width: 1200px) {
        #tablaBrotes {
            font-size: 11px;
        }
    }

    /* Hacer la tabla horizontalmente scrolleable */
    .table-responsive {
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block title %}Lista de Brotes{% endblock %}

{% block content %}
<!-- Definir el origen para esta página -->
{% set page_origin = 'lista_brotes' %}

<h2>Brotes registrados</h2>
<div style="margin-bottom: 20px;">
    <a href="{{ url_for('brotes_bp.exportar_excel_lista') }}" class="btn-excel mb-3">
        Exportar a Excel
    </a>
</div>
<table style="font-size: 14px;" id="tablaBrotes" class="table table-striped table-bordered table-responsive">
    <thead>
        <tr>
            <th>No.</th>
            <th>Tipo Evento</th>            
            <th>Institución</th>
            <th>Unidad Notificante</th>            
            <th>Municipio</th>
            <th>Jurisdicción</th>
            <th>Fecha Notificación</th>
            <th>Diagnóstico Sospecha</th>
            <th style="width: 100px;">Fecha Inicio</th>            
            <th style="width: 100px;">Fecha Último Caso</th>            
            <th>Folio Notinmed Inicial</th>            
            <th>Estatus</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for brote in brotes %}
        <tr>
            <td>{{ brote['idbrote'] }}</td>
            <td>{{ brote['Tipo evento'] }}</td>            
            <td>{{ brote['Institución'] }}</td>
            <td>{{ brote['Unidad notificante'] or '' }}</td>            
            <td>{{ brote['Municipio'] }}</td>
            <td>{{ brote['Jurisdicción'] }}</td>
            <td>{{ brote['Fecha notificación'].strftime('%d-%m-%Y') if brote['Fecha notificación'] else '' }}</td>
            <td>{{ brote['Diagnóstico Sospecha'] }}</td>
            <td>{{ brote['Fecha inicio'].strftime('%d-%m-%Y') if brote['Fecha inicio'] else '' }}</td>            
            <td>{{ brote['Fecha Última Caso'].strftime('%d-%m-%Y') if brote['Fecha Última Caso'] else '' }}</td>                        
            <td>{{ brote['Folio Notinmed Inicial'] or '' }}</td>            
            <td>
                {% if brote['Estatus'] == 'Activo' %}
                <span class="badge bg-success">Activo</span>
                {% elif brote['Estatus'] == 'Pendiente Alta' %}
                <span class="badge bg-warning text-dark">Pendiente Alta</span>
                {% elif brote['Estatus'] == 'Alta' %}
                <span class="badge bg-secondary">Alta</span>
                {% else %}
                <span class="badge bg-info">{{ brote['Estatus'] or 'Sin estado' }}</span>
                {% endif %}
            </td>
            <td>
                <div class="btn-group">
                    {% if current_user.is_authenticated and current_user.rol in ['coordinador_estatal',
                    'jefe_departamento','super_administrador'] %}
                    <a href="{{ url_for('brotes_bp.editar_brote', idbrote=brote.idbrote) }}"
                        class="btn btn-sm btn-outline-dark edit-btn" 
                        title="Editar"
                        data-idbrote="{{ brote['idbrote'] }}"
                        data-origen="{{ page_origin }}">
                        <i class="fas fa-edit"></i>
                    </a>                    

                    <!-- PENDIENTE REALIZAR LOGICA -->
                    <a href="/edit_brote/{{ brote.idbrote }}" class="btn btn-sm btn-outline-dark delete-btn"
                        title="Eliminar">                        
                        <i class="fas fa-trash"></i>
                    </a>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>


{% endblock %}

{% block scripts %}
<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<!-- Extensiones para exportar -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<!-- <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Idioma español -->
<script src="https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json"></script>

<!-- <script>
    $(document).ready(function () {
        $('#tablaBrotes').DataTable({
            dom: '<"row mb-3"<"col-sm-1"l><"col-sm-7"><"col-sm-4"f>>t<"row mt-3"<"col-sm-6"i><"col-sm-6"p>>',
            pagingType: 'full_numbers',
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json',
                search: "Buscar:",
                lengthMenu: "Mostrar _MENU_ registros",
                info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                paginate: {
                    first: "Primero",
                    last: "Último",
                    next: "Siguiente",
                    previous: "Anterior"
                }
            },
            pageLength: 10,
            order: [[0, 'asc']]
        });
    });
</script> -->



<script>
$(document).ready(function () {
    // Clave única para el localStorage de esta página
    const STORAGE_KEY = 'lista_brotes_datatable_state';
    
    // Configuración de DataTable con preservación de estado
    const tableConfig = {
        dom: '<"row mb-3"<"col-sm-1"l><"col-sm-7"><"col-sm-4"f>>t<"row mt-3"<"col-sm-6"i><"col-sm-6"p>>',
        pagingType: 'full_numbers',
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json',
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            paginate: {
                first: "Primero",
                last: "Último",
                next: "Siguiente",
                previous: "Anterior"
            }
        },
        pageLength: 10,
        // order: [[0, 'asc']],
        // Habilitar preservación de estado
        stateSave: true,
        stateDuration: 60 * 60 * 24, // 24 horas
        // Personalizar qué se guarda en el estado
        stateSaveCallback: function(settings, data) {
            // Guardar estado en localStorage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        },
        stateLoadCallback: function(settings) {
            // Cargar estado desde localStorage
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : null;
        }
    };
    
    // Inicializar DataTable
    const table = $('#tablaBrotes').DataTable(tableConfig);
    
    // Manejar clic en botón editar con preservación de estado
    $('.edit-btn').on('click', function(e) {
        e.preventDefault();
        
        const idbrote = $(this).data('idbrote');
        const origen = $(this).data('origen');
        
        // Obtener estado actual de la tabla
        const currentState = table.state();
        
        // Crear parámetros adicionales para preservar el estado
        const stateParams = {
            page: table.page.info().page, // Página actual (0-indexada)
            length: table.page.len(),     // Registros por página
            search: table.search(),       // Término de búsqueda actual
            order: table.order()          // Orden actual
        };
        
        // Codificar el estado como base64 para pasarlo en la URL
        const encodedState = btoa(JSON.stringify(stateParams));
        
        // Construir URL con todos los parámetros necesarios
        const editUrl = "{{ url_for('brotes_bp.editar_brote', idbrote=0) }}".replace('0', idbrote) + 
                       `?origen=${origen}&state=${encodedState}`;
        
        // Navegar a la página de edición
        window.location.href = editUrl;
    });
    
    // Restaurar estado si venimos de una edición
    const urlParams = new URLSearchParams(window.location.search);
    const returnState = urlParams.get('return_state');
    
    if (returnState) {
        try {
            const stateData = JSON.parse(atob(returnState));
            
            // Aplicar el estado restaurado
            if (stateData.page !== undefined) {
                table.page(stateData.page);
            }
            if (stateData.length) {
                table.page.len(stateData.length);
            }
            if (stateData.search) {
                table.search(stateData.search);
            }
            if (stateData.order) {
                table.order(stateData.order);
            }
            
            // Redibujar la tabla con el estado restaurado
            table.draw(false);
            
            // Limpiar el parámetro de la URL sin recargar la página
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
            
            console.log('Estado de tabla restaurado exitosamente');
            
        } catch (error) {
            console.error('Error al restaurar estado de tabla:', error);
        }
    }
    
    // Confirmar eliminación
    $('.delete-btn').on('click', function(e) {
        e.preventDefault();
        const url = $(this).attr('href');
        const idbrote = $(this).data('idbrote');
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: '¿Está seguro?',
                text: `¿Desea eliminar el brote #${idbrote}? Esta acción no se puede deshacer`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = url;
                }
            });
        } else {
            const confirmed = confirm(`¿Está seguro de eliminar el brote #${idbrote}? Esta acción no se puede deshacer`);
            if (confirmed) {
                window.location.href = url;
            }
        }
    });    
    
});
</script>

{% endblock %}