{% extends "layout.html" %}

{% block head %}

<!-- DataTables + Botones -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<style>
    /* Estilos para el tamaño de los controles */
    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {        
        width: 50px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem; /* Tamaño reducido */
        border-radius: 25px;
    }

    /* Controles alineados horizontalmente */
    .dataTables_wrapper .dataTables_filter {
        width: 100px !important;
        float: left !important;
        text-align: left !important;
    }
    .dataTables_wrapper .dataTables_length {        
        width: 80px !important;
        float: right !important;
        text-align: right !important;
    }

    /* Estilos para botones del paginado */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.3rem 0.6rem;
        font-size: 0.875rem;
        border-radius: 5px;
        background-color: #0d6efd;
        color: white !important;
        margin: 0 2px;
        border: none;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background-color: #0b5ed7;
        color: white !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background-color: #198754 !important;
        color: white !important;
    }

    .table tbody tr td {
        font-size: 6px;
    }    


    /* Estilos adicionales para mejorar la visualización */
    #tablaBrotes {
        font-size: 12px;
        width: 100%;
    }


    /* Responsive adjustments */
    @media (max-width: 1200px) {
        #tablaBrotes {
            font-size: 11px;
        }
    }

    /* Hacer la tabla horizontalmente scrolleable */
    .table-responsive {
        overflow-x: auto;
    }



    /* Estilos para SweetAlert2 personalizado */
    .swal2-html-container ul {
        text-align: left;
        padding-left: 20px;
    }

    .swal2-html-container .alert {
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0.5rem;
    }

    .swal2-html-container .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c2c7;
        color: #842029;
    }

    .swal2-styled.btn {
        padding: 0.5rem 1.5rem;
        font-weight: 600;
    }

    .swal2-styled.btn-lg {
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block title %}Lista de Brotes{% endblock %}

{% block content %}
<!-- Definir el origen para esta página -->
{% set page_origin = 'lista_brotes' %}


 {% include 'brotes/navs.html' %}

<table style="font-size: 14px;" id="tablaBrotes" class="table table-striped table-bordered table-responsive">
    <thead>
        <tr>
            <th>No.</th>
            <th>Tipo Evento</th>            
            <th>Institución</th>
            <th>Unidad Notificante</th>            
            <th>Municipio</th>
            <th>Jurisdicción</th>
            <th>Fecha Notificación</th>
            <th>Diagnóstico Sospecha</th>
            <th style="width: 100px;">Fecha Inicio</th>            
            <th style="width: 100px;">Fecha Último Caso</th>            
            <th>Folio Notinmed Inicial</th>            
            <th>Estatus</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for brote in brotes %}
        <tr>
            <td>{{ brote['idbrote'] }}</td>
            <td>{{ brote['Tipo evento'] }}</td>            
            <td>{{ brote['Institución'] }}</td>
            <td>{{ brote['Unidad notificante'] or '' }}</td>            
            <td>{{ brote['Municipio'] }}</td>
            <td>{{ brote['Jurisdicción'] }}</td>
            <td>{{ brote['Fecha notificación'].strftime('%d-%m-%Y') if brote['Fecha notificación'] else '' }}</td>
            <td>{{ brote['Diagnóstico Sospecha'] }}</td>
            <td>{{ brote['Fecha inicio'].strftime('%d-%m-%Y') if brote['Fecha inicio'] else '' }}</td>            
            <td>{{ brote['Fecha Última Caso'].strftime('%d-%m-%Y') if brote['Fecha Última Caso'] else '' }}</td>                        
            <td>{{ brote['Folio Notinmed Inicial'] or '' }}</td>            
            <td>
                {% if brote['Estatus'] == 'Activo' %}
                <span class="badge bg-success">Activo</span>
                {% elif brote['Estatus'] == 'Pendiente Alta' %}
                <span class="badge bg-warning text-dark">Pendiente Alta</span>
                {% elif brote['Estatus'] == 'Alta' %}
                <span class="badge bg-secondary">Alta</span>
                {% else %}
                <span class="badge bg-info">{{ brote['Estatus'] or 'Sin estado' }}</span>
                {% endif %}
            </td>
            <td>
                <div class="btn-group">
                    {% if current_user.is_authenticated and current_user.rol in ['coordinador_estatal',
                    'jefe_departamento','super_administrador'] %}
                    <a href="{{ url_for('brotes_bp.editar_brote', idbrote=brote.idbrote) }}"
                        class="btn btn-sm btn-outline-dark edit-btn" 
                        title="Editar"
                        data-idbrote="{{ brote['idbrote'] }}"
                        data-origen="{{ page_origin }}">
                        <i class="fas fa-edit"></i>
                    </a>                                        
                    <a href="javascript:void(0);" 
                        class="btn btn-sm btn-outline-danger delete-btn"
                        data-idbrote="{{ brote.idbrote }}"
                        data-lugar="{{ brote.lugar }}"
                        title="Eliminar">
                            <i class="fas fa-trash"></i>
                    </a>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>


{% endblock %}

{% block scripts %}
<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<!-- Extensiones para exportar -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Idioma español -->
<script src="https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json"></script>



<script>
// Token CSRF disponible globalmente
const csrfToken = '{{ csrf_token() }}';

$(document).ready(function () {
    // Clave única para el localStorage de esta página
    const STORAGE_KEY = 'lista_brotes_datatable_state';
    
    // Configuración de DataTable con preservación de estado
    const tableConfig = {
        dom: '<"row mb-3"<"col-sm-1"l><"col-sm-7"><"col-sm-4"f>>t<"row mt-3"<"col-sm-6"i><"col-sm-6"p>>',
        pagingType: 'full_numbers',
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json',
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            paginate: {
                first: "Primero",
                last: "Último",
                next: "Siguiente",
                previous: "Anterior"
            }
        },
        pageLength: 10,
        // order: [[0, 'asc']],
        // Habilitar preservación de estado
        stateSave: true,
        stateDuration: 60 * 60 * 24, // 24 horas
        // Personalizar qué se guarda en el estado
        stateSaveCallback: function(settings, data) {
            // Guardar estado en localStorage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        },
        stateLoadCallback: function(settings) {
            // Cargar estado desde localStorage
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : null;
        }
    };
    
    // Inicializar DataTable
    const table = $('#tablaBrotes').DataTable(tableConfig);
    
    // Manejar clic en botón editar con preservación de estado
    $('.edit-btn').on('click', function(e) {
        e.preventDefault();
        
        const idbrote = $(this).data('idbrote');
        const origen = $(this).data('origen');
        
        // Obtener estado actual de la tabla
        const currentState = table.state();
        
        // Crear parámetros adicionales para preservar el estado
        const stateParams = {
            page: table.page.info().page, // Página actual (0-indexada)
            length: table.page.len(),     // Registros por página
            search: table.search(),       // Término de búsqueda actual
            order: table.order()          // Orden actual
        };
        
        // Codificar el estado como base64 para pasarlo en la URL
        const encodedState = btoa(JSON.stringify(stateParams));
        
        // Construir URL con todos los parámetros necesarios
        const editUrl = "{{ url_for('brotes_bp.editar_brote', idbrote=0) }}".replace('0', idbrote) + 
                       `?origen=${origen}&state=${encodedState}`;
        
        // Navegar a la página de edición
        window.location.href = editUrl;
    });
    
    // Restaurar estado si venimos de una edición
    const urlParams = new URLSearchParams(window.location.search);
    const returnState = urlParams.get('return_state');
    
    if (returnState) {
        try {
            const stateData = JSON.parse(atob(returnState));
            
            // Aplicar el estado restaurado
            if (stateData.page !== undefined) {
                table.page(stateData.page);
            }
            if (stateData.length) {
                table.page.len(stateData.length);
            }
            if (stateData.search) {
                table.search(stateData.search);
            }
            if (stateData.order) {
                table.order(stateData.order);
            }
            
            // Redibujar la tabla con el estado restaurado
            table.draw(false);
            
            // Limpiar el parámetro de la URL sin recargar la página
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
            
            console.log('Estado de tabla restaurado exitosamente');
            
        } catch (error) {
            console.error('Error al restaurar estado de tabla:', error);
        }
    }


    
    // Confirmar eliminación de brote con advertencia de documentos
$('.delete-btn').on('click', function(e) {
    e.preventDefault();
    
    const idbrote = $(this).data('idbrote');    
    const url = `/brotes/eliminar/${idbrote}`;
    
    console.log('URL a llamar:', url);
    
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: '⚠️ ¿Está seguro?',
            html: `
                <div class="text-start">
                    <p class="mb-3">¿Desea eliminar el brote <strong>#${idbrote}</strong>?</p>                    
                    <hr>
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ADVERTENCIA:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Se eliminará el brote permanentemente</li>
                            <li>Se eliminarán TODOS los documentos asociados</li>
                            <li>Los archivos físicos serán borrados del servidor</li>
                            <li><strong>Esta acción NO se puede deshacer</strong></li>
                        </ul>
                    </div>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="fas fa-trash me-2"></i>Sí, eliminar todo',
            cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
            width: '600px',
            customClass: {
                confirmButton: 'btn btn-danger btn-lg',
                cancelButton: 'btn btn-secondary btn-lg'
            },
            buttonsStyling: false,
            reverseButtons: true,
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Segundo nivel de confirmación (doble check)
                Swal.fire({
                    title: '¿Confirma la eliminación?',
                    html: `
                        <p>Esta es la <strong>última confirmación</strong>.</p>
                        <p class="text-danger mb-0">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            El brote #${idbrote} y todos sus documentos serán eliminados permanentemente.
                        </p>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, estoy seguro',
                    cancelButtonText: 'No, cancelar',
                    customClass: {
                        confirmButton: 'btn btn-danger',
                        cancelButton: 'btn btn-secondary'
                    },
                    buttonsStyling: false,
                    reverseButtons: true
                }).then((finalResult) => {
                    if (finalResult.isConfirmed) {
                        // Mostrar loading
                        Swal.fire({
                            title: 'Eliminando...',
                            html: `
                                <p>Por favor espere mientras se eliminan:</p>
                                <ul class="text-start">
                                    <li>Registro del brote</li>
                                    <li>Documentos asociados</li>
                                    <li>Archivos físicos del servidor</li>
                                </ul>
                            `,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        
                        // Realizar petición DELETE
                        fetch(url, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            }
                        })
                        .then(response => {
                            console.log('Status:', response.status);
                            console.log('Content-Type:', response.headers.get('content-type'));
                            
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                return response.json();
                            } else {
                                return response.text().then(text => {
                                    console.error('Respuesta HTML:', text);
                                    throw new Error('El servidor devolvió HTML en lugar de JSON');
                                });
                            }
                        })
                        .then(data => {
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            
                            // Éxito
                            Swal.fire({
                                icon: 'success',
                                title: '¡Eliminado!',
                                html: `
                                    <p class="mb-2">El brote ha sido eliminado correctamente</p>
                                    <small class="text-muted">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Brote, documentos y archivos eliminados
                                    </small>
                                `,
                                timer: 3000,
                                timerProgressBar: true,
                                showConfirmButton: false
                            }).then(() => {
                                // Recargar la página
                                location.reload();
                            });
                        })
                        .catch(error => {
                            console.error('Error completo:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error al eliminar',
                                html: `
                                    <p class="mb-2">${error.message || 'No se pudo eliminar el brote'}</p>
                                    <small class="text-muted">Revisa la consola para más detalles</small>
                                `,
                                confirmButtonText: 'Entendido',
                                customClass: {
                                    confirmButton: 'btn btn-primary'
                                },
                                buttonsStyling: false
                            });
                        });
                    }
                });
            }
        });
    } else {
        // Sin SweetAlert2 - Confirmación nativa con advertencia detallada
        const mensaje = `⚠️ ADVERTENCIA IMPORTANTE ⚠️\n\n` +
                       `¿Está seguro de eliminar el brote #${idbrote}?\n\n` +
                       `Lugar: ${lugar}\n\n` +
                       `SE ELIMINARÁ:\n` +
                       `- El registro del brote\n` +
                       `- Todos los documentos asociados\n` +
                       `- Los archivos físicos del servidor\n\n` +
                       `⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER ⚠️\n\n` +
                       `¿Desea continuar?`;
        
        const confirmed = confirm(mensaje);
        
        if (confirmed) {
            // Segunda confirmación
            const segundaConfirmacion = confirm(
                `ÚLTIMA CONFIRMACIÓN\n\n` +
                `¿Está completamente seguro de eliminar el brote #${idbrote} y TODOS sus documentos?\n\n` +
                `Esta es su última oportunidad para cancelar.`
            );
            
            if (segundaConfirmacion) {
                // Realizar petición DELETE
                fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al eliminar');
                    }
                    return response.json();
                })
                .then(data => {
                    alert('✓ Brote eliminado correctamente\n\nSe eliminaron el brote, documentos y archivos físicos.');
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('✗ Error al eliminar el brote:\n\n' + error.message);
                });
            }
        }
    }
});



    
});
</script>

{% endblock %}